# VastuSLAM Configuration
# Units: meters (m), radians (rad), cells (n)

# ============================================================================
# Grid Configuration
# ============================================================================
[grid]
# Cell resolution in meters per cell
resolution = 0.025  # 2.5cm cells

# Initial grid dimensions (cells)
initial_width = 800   # 20m at 2.5cm
initial_height = 800  # 20m at 2.5cm

# Grid origin mode: "center" or "corner"
origin_mode = "center"

# Custom origin offset (only used if origin_mode: corner)
origin_x = 0.0
origin_y = 0.0

# Enable automatic grid expansion
auto_expand = true

# ============================================================================
# Sensor Configuration
# ============================================================================
[sensor.lidar]
# Note: Lidar offset is now handled by SangamIO (hardware config)
# Range limits
min_range = 0.15
max_range = 8.0

[sensor.robot]
radius = 0.17  # CRL-200S physical radius

[sensor.cliff_sensors]
left_side = [0.12, 0.10]
left_front = [0.15, 0.05]
right_front = [0.15, -0.05]
right_side = [0.12, -0.10]

[sensor.bumper]
# Bumper zones (angles from center in radians)
left_angle = 0.5   # ~30 degrees
right_angle = -0.5

# ============================================================================
# SLAM Configuration
# ============================================================================
[slam.log_odds]
# Log-odds occupancy model (Cartographer-style)
# Log-odds increment for hit (lidar endpoint)
# Cartographer default: ~20 (P=0.55)
l_hit = 20

# Log-odds decrement for miss (ray passes through)
# Asymmetric to make walls "stickier" than free space
l_miss = -4

# Cell classification thresholds
l_occupied_threshold = 50
l_free_threshold = -50

# Clamping range (probability bounds)
l_min = -200  # P ~ 0.12
l_max = 200   # P ~ 0.88

[slam.correlative]
# Correlative scan matcher
enabled = true

# Search window
search_x = 0.3          # meters
search_y = 0.3          # meters
search_theta = 0.15     # radians (~8.6 degrees)

# Search resolution
linear_resolution = 0.02    # 2cm
angular_resolution = 0.02   # ~1.1 degrees

# Multi-resolution search (coarse-to-fine)
multi_resolution = true
coarse_factor = 2.0

# Gaussian scoring (uses distance field)
use_gaussian_scoring = true
gaussian_sigma = 0.10       # 10cm - matches 2x grid resolution

# Gauss-Newton refinement for sub-pixel accuracy
gn_max_iterations = 10
gn_convergence_threshold = 1e-5
gn_damping = 1e-3
gn_translation_weight = 500.0   # Trust encoder distance
gn_rotation_weight = 20.0       # Allow heading correction

# Match quality threshold
min_score = 0.5

# Maximum points to use (0 = all)
max_points = 0

[slam.loop_closure]
# Loop closure detection
enabled = true

# Keyframe creation thresholds
keyframe_distance = 0.5     # 50cm between keyframes
keyframe_rotation = 0.5     # ~28 degrees

# LiDAR-IRIS descriptor matching
max_descriptor_distance = 100   # Out of 640 bits

# Spatial constraints
min_loop_gap = 20           # Minimum pose index gap
max_loop_distance = 5.0     # Maximum spatial distance (m)

# Verification via scan matching
min_verification_score = 0.6
use_branch_bound = true     # Use branch-and-bound instead of correlative

# Verification search window
verification_search_window = 0.2   # 20cm
verification_angular_window = 0.2  # ~11 degrees

[slam.pose_graph]
# Pose graph optimization
max_iterations = 20
convergence_threshold = 1e-4
damping = 1e-3

# Edge weights
odometry_weight = 100.0     # Strong trust in encoder odometry
loop_weight = 50.0          # Lower to handle noise

# Huber loss for robust optimization (downweight outliers)
huber_scale = 0.1           # 10cm

[slam.background_optimizer]
# Background optimizer
max_iterations = 50
convergence_threshold = 1e-5
huber_scale = 0.1

# Trigger optimization every N nodes (0 = only on loop closure)
trigger_every_n_nodes = 0

# Background thread (not recommended for ARM)
use_background_thread = false

# ============================================================================
# Map Persistence
# ============================================================================
[persistence]
# Output format: "vastu" (binary), "pgm" (ROS), "both"
output_format = "both"

# Output directory (relative to working directory)
output_dir = "./output"

# Auto-save interval during exploration (seconds, 0=disabled)
auto_save_interval = 30
